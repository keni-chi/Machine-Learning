# time series

時系列モデルの種類
    Moving Window (MW) モデル
        新しいサンプルの測定時刻と最も古いサンプルの測定時刻との間の幅 (窓、window) を移動 (moving) しながら、モデルの再構築を繰り返す。
        新しく y の値が測定されたら回帰モデルが再構築される。
    Just-In-Time (JIT) モデル
        y の値を推定するごとに回帰モデルが再構築される。
        トレーニングデータの数は事前に決める必要がある。
    時間差分 (Time Difference, TD) モデル
        これまで回帰モデルは、X の値と y の値との間で構築された。時間差分 (Time Difference, TD) モデルでは、X の時間差分の値と y の時間差分の値との間で回帰モデルが構築される。
        TD モデルでは回帰モデルは再構築されない。更新されるのは、推定された y の時間差分の値に足し合わされる、直近の y の実測値。
        ただ、TD モデルにおいては、基本的に回帰分析手法は線形手法に限られる。

時系列データ
    自己相関
        時系列上にある異なる点同士の相関のこと
        自己相関を用いることで、データの前後の関係を表現
        自己相関はコレログラムというグラフで表すことができる
    偏自己相関
        自己相関が時系列データのn次遅れのデータそれぞれに行うに対して、偏自己相関は自己相関係数から、時間によって受ける影響を除去した自己相関となる
    周期性(seasonal)
        １２ヶ月周期で似た変化をしたり、曜日によって周期的な変化をしたりすること。
    トレンド
        全体の傾向。なんとなく上昇傾向がある、など。
    外因性
        上記はデータの中での特徴だが、外因性は自己相関だけでは説明できないデータの動きのこと。
    ホワイトノイズ
        これまで述べたデータの特徴以外で説明不可能なノイズをホワイトノイズ。残差(Residuals)など。
            残差
                推定した回帰式と実際のデータの値との差

定常/非定常
    定常過程（レベル定常）
        定常性
            時間によらず期待値、自己共分散（自分自身の時間をずらしたバージョンとの共分散）が一定であるような時系列データの性質
        ARモデル（自己回帰モデル）
            時間の変化に対し規則的に値が変化する、最も単純な時系列モデル
        MAモデル（移動平均モデル）
            時間の変化に対し不規則に値が変化します。 ただし、ある区間での変動が一定である
        ARMAモデル（自己回帰移動平均モデル）
            ARモデルとMAモデルの組み合わせ
    非定常過程
        ARIMAモデル（自己回帰和分移動平均モデル）
            ARMAモデルに加えて、前後のデータ間の差分dを定義（d：トレンド要素）
        単位根過程
            ARIMA過程のうち、特に元の時系列が非定常過程である一方で差分系列が定常過程である
            利用
                時系列データの回帰分析を行う時、単位根過程について考える必要があります。
                「見せかけの回帰」
                    単位根過程に従う𝑥𝑡,𝑦𝑡 を回帰分析を行うと、まったく関係のない𝑥𝑡,𝑦𝑡の間に有意な相関を見出してしまうこと
                「見せかけの回帰」を避けるためには、あらかじめ２つの時系列データ𝑥𝑡,𝑦𝑡が単位根過程に従っているかどうか確認
                    例：株価と二酸化炭素濃度
                        ⇨単位根検定
        SARIMAモデル（季節自己回帰和分移動平均モデル）
            ARIMAモデルにさらに長期的な季節変動を取り入れたモデル

第 1 部 時系列分析の考え方
    自己共分散
        統計学における確率過程での、自分自身の時間をずらしたバージョンとの共分散
    ランダムウォーク
        次に現れる位置が確率的に無作為（ランダム）に決定される運動
第 2 部 Box-Jenkins 法とその周辺
    Box-Jenkins 法
        概要
            1. まず非定常過程の時系列データから，トレンドやら季節変動などを「余計なもの」として除去して定常過程に直す 
                自己相関係数や自己偏相関係係数をみて自己回帰の次数決定やデータの水平化を行いモデルを特定
            2. 定常過程に直したものに対して，ARやMAモデルを組み合わせたARMA（自己回帰移動平均モデル）で分析する 
                特定したモデルのパラメータを平均平方誤差が最小になるよう推定し、誤差を検討して妥当性を診断
        メリット
            古典的だが手続きが確立した手法（柔軟性はない）
        デメリット
            欠損値があるとダメ。
            目的変数は連続量
            短期的な予測のみ有効？
    差分系列（階差系列）
        1時点離れたデータとの差をとったデータのこと
            Δ𝑦𝑡=𝑦𝑡−𝑦𝑡−1
    和分過程
        単位根過程とよく似ている
        和分過程は一階の差分だけでなくｄ階差分について考えることができる
    対数差分系列
        対数系列に対して差分系列をとったもの
        https://dev.classmethod.jp/statistics/basis-of-ts-data-analysis-reading-memo/
    反転可能性
        MA(q)過程が反転可能(invertible)とは、そのMA(q)過程をAR(∞)過程に書きなおせることです。
        MA特性方程式の全ての解の絶対値が1より大きければMA過程は反転可能になる。
    ARIMAX
        ARIMAモデルは基本的には１変量による自己回帰。
        時系列データにはない外部要因を入れて評価したい場合にARIMAXを用いる。
            例：曜日とか天気とか気温とかそういう効果を取り入れたいときに、使用するモデル。
        メリット
            安定的かつ周期性のあるデータには有用
        デメリット
            データから潜在的なプロセス（データの要因）は分解不可能
            正規分布でなく非線形でもない
    AIC(赤池情報量規準)
        統計モデルの良さを評価するための指標
        AIC最小のものを選択すれば常に最良であるかと言うと一概にはそう言えない
            AIC=-2lnL+2p
            モデルの対数尤度をL、モデルに含まれるパラメーター数p
    単位根検定
        KPSS検定
            xはレベル定常ないしトレンド定常である
            トレンド定常
                潜在的なトレンド（時間のみの関数）を取り除けば、定常過程となる場合のこと。
        ADF検定
            xは単位根を持つ。
        PP検定
            xは単位根を持つ。
    評価
        モデルの定常性・反転可能性のチェック
        残差の自己相関のテスト
        残差の正規性のテスト
            回帰分析の結果から残差を計算しQQ plotを描く。残差のプロットが直線状に乗っている場合は、正規分布していると見ていい。
    ナイーブ予測との比較
        ナイーブ予測とは
            直前の実測値をそのままスライドさせて“予測値”に充てる方法
        比較方法
            ナイーブ予測のRMSEと、構築したSARIMAモデルのRMSEを比較して、SARIMAモデルの方が小さければ、十分に良い予測ができていると判断
        例
            https://logics-of-blue.com/time-series-forecast-and-evaluation-with-cv/
            訓練データの最終時点を予測値とする
            トレンド付きのナイーブ予測
            季節付きのナイーブ予測
第 3 部 時系列分析のその他のトピック
    見せかけの回帰とその対策
        見せかけの回帰
            統計学や計量経済学において、統計的に独立である無関係の二つの時系列変数が最小二乗法による回帰分析において統計的に有意な係数の推定値を取ってしまうという問題
            回帰分析に用いる２つの時系列データがどちらも単位根過程に従うときに現れる
        見せかけの回帰を回避する方法
            ラグ付きの回帰
                1期前の説明変数、もしくは被説明変数を説明変数として加える事で見せかけの回帰は回避できる
            差分を取った回帰
                説明変数と被説明変数の差分に対する関係を見る方法
        Durbin-Watson検定
            線形回帰の残差中の自己相関を検出するために使用される
            帰無仮説: 誤差は相関していない（線形回帰からの残差が無相関である）
        一般化最小二乗法：GLS
            誤差系列に相関がある場合の最良不偏推定量をもとめる方法。（通常の最小二乗法は一般化最小二乗法の特殊なケースである。）
        Prais-Winsten法
            誤差項の自己相関による系列相関がある場合の推定方法
        共和分
            二つの単位根過程 𝑥𝑡, 𝑦𝑡の線形和 𝑥𝑡+𝛽𝑦𝑡=𝑧𝑡が定常過程に従う時、この二つは共和分の関係を持つ
        共和分検定
            Phillips–Ouliarisの共和分検定
                複数の時系列データが共和分の関係にあるかどうか
    VAR モデル
        VAR モデル 
            自己回帰(AR)モデルを多変量に拡張したもの。
            複数の変数を用いることで予測精度の向上が見込まれる。
        グレンジャー因果（Granger因果性検定）
            ある二つの時系列データが与えられたときにその時系列間にグレンジャー因果性があるかどうかを判定。
            グレンジャー因果は本当の因果関係ではなくあくまで片方のデータ列を使うことでもう片方のデータ列単体でそのデータ列の未来を推定するよりもっと良く推定できる関係。
            データのみから因果性の判断を行うことができる
            時系列ytの予測において、時系列xtを用いると予測精度が向上した場合、xtからytへの因果性があるという考え方
            短所としては、まずグレンジャー因果性は通常の因果性とは異なる。また、因果の方向が実際と真逆になることもある。
        インパルス応答関数
            ある変数時系列の変化がその変数時系列やその他の変数時系列に与える影響を分析することができる
    ARCHモデル
        正式名称は自己回帰条件付き分散不均一モデル(Auto Regressive Heteroskedasticity model)
        ARは自己回帰モデルのARと同じ意味
        株価によくある「前回絶対値の大きなノイズが来たのであれば今回の分散は大きくなるだろう」のモデル
        ARCH(q)モデル
            q 期前までの平均からの乖離部分の2乗が条件付きボラティリティに影響
        GARCH(p,q)モデル
            ARCHモデルを一般化
            現在の条件付ボラティリティは、p 期前までの条件付ボラティリティ（変動の程度）と q 期前までの平均からの乖離部分の2乗により決定
        GARCH(p,q)モデルの拡張
            EGARCHモデル
            GJR GARCHモデル
            Heston-Nandi GARCH モデル
        多変数モデルへの拡張
            GARCHモデルはいずれも単一変数の時系列データに対して適用されるものであったが、多変数の時系列データに対してその相関構造を内包しつつ適用可能なGARCHモデルも存在する
第 4 部 状態空間モデルとは何か
    1 章 状態空間モデルとは何か
        1－1 状態空間モデルとは何か
            1960年代にカルマンにより、制御工学での利用が進み、1970年代、赤池により統計科学への応用、1990年代、金融データに対する応用が盛んになり、2000年以降、ボラティリティの推定、債券価格やコモディティ価格のモデリングなどでモデルの研究が進んだ。
            状態空間モデルは、ほとんどの時系列モデルを表現できる汎用性の高い時系列分析のモデル。
            状態空間モデルは、観測できない隠れた「状態モデル」（例えば市況）と観測した結果である「観測モデル」（例えば株価）からなる。
        1－2 状態空間モデルのメリット・デメリット
            ・観測できない状態を構造に組み込むことで、AR/MA/ARMA/ARIMAと比較し、より複雑な時系列モデルを構成することができる。
            ・カルマンフィルターをはじめとした、様々なモデルとそれに対応した数値計算アルゴリズムが知られており、多くの分野に応用されている。
            ・時系列予測をさまざまな要因分解の結果として行なえるため、時変パラメータの解釈や可視化が容易で、売上に対する広告影響の構造把握などができる。
            ・過去の知見や自身の直感を，自由に表現してモデル化できる
            ・推定されたモデルの解釈が容易である
            ・差分をとるなどの前処理が不要
            ・欠損値が含まれていても分析可能
    2 章 状態空間モデルの学び方
        データの表現：状態方程式・観測方程式(線形ガウス状態空間モデル)
            状態方程式 Xt = Ft*Xt-1 + Gt*Vt
                Xt状態、Vt状態ノイズ
            観測方程式 Yt = Ht*Xt + Wt
                Yt観測値、Wt観測ノイズ
        パラメタ推定：カルマンフィルタと最尤法
            パラメーターに制約を加えれば（例えば線形関係・正規分布を仮定するなど）、パラメーターと状態を効率よく推定できる方法がいくつかある。これらの方法には、カルマンフィルタ、拡張カルマンフィルタや粒子フィルタなどがある。
        パラメタ推定：ベイズ推論と HMC 法
            逆に、パラメーターに制限を加えることができない場合は、ベイズ推定で、状態とパラメーターの両方を同時にを推定していく必要がある。
第 5 部 状態空間モデルとカルマンフィルタ
    1 章 線形ガウス状態空間モデルとカルマンフィルタ
        ARIMAモデルを主とした時系列モデルは、予測しかできなかった。しかし、状態空間モデルを使えば、予測だけでなく、「データの解釈」を進めることができる。
        ARIMAモデルなどのBox-Jenkins法は、内部がブラックボックス化しており、データの解釈は困難である。
        状態空間モデルは色々なバリエーションを持たせることができる、汎用的な統計モデル。
    2 章 表現：状態方程式・観測方程式による表現技法
        ローカルレベルモデル
            見えない状態の部分がランダムウォークしているとみなしているモデルのこと。
            状態がランダムウォークしていて、それに観測誤差であるところのノイズが加わって生じたのが観測値だ、とみなす。
            そのため、別名がランダムウォーク　プラス　ノイズモデル。
            ローカルレベルモデルは推定は簡単なのですが、じつは「来期の予測値は前期の観測値と同じ」という予測結果を出す。逆に言えば、ローカルレベルモデル以上の予測結果が出せなければ、複雑なモデルを使う意味がないということとなる。
        ローカル線形トレンドモデル
        基本構造時系列モデル
            構造時系列モデルとは
                注目している時系列を、直接解釈可能な複数の時系列の和で表すモデルで、任意の時系列の足し合わせであるため解釈性が高いというメリットがある。
                なかでも、基本的な構造時系列モデルは次の構造で表される。
                    時系列データ=トレンド+周期成分+ホワイトノイズ
                構造時系列（STS）モデル は時系列を扱う確率モデルの一種で、次のような多くの標準的な時系列モデルの考え方を取り入れて汎用化したもの。
                STS モデルは、観測された時系列をより簡単な構成要素の合計として表現する。
                    自己回帰プロセス
                    移動平均
                    ローカル線形トレンド
                    周期性
                    外部共変量（関心対象の時系列に関係する可能性がある他の時系列）に対する回帰と変数選択
        外生変数と時変係数モデル
            外生変数
                あるシステムを数理モデルとして表現する方程式体系において、その体系内で決定されずに外部から値が与えられる変数
            時変係数モデル
                共分散⾮定常
    3 章 状態推定：カルマンフィルタ
        カルマンフィルタとカルマンゲイン
            カルマンフィルタ
                複数の不確実な情報を用いて，より正確な情報を推定する
                応用
                    カーナビ、異常検知、物体追跡
                用語
                    「システム」とは，推定したい状態を保持しているもののこと　例：ロボット、トロッコ
                    「状態」とは，推定したい値，またはシステムが持っている真の値のこと  例：位置
                カルマンフィルタは，odometryとobservationという2つの値を用いて真の状態を推定する
                    odometry
                        過去(1タイムステップ前)の推定値と，現在のシステムへの入力のみから導かれる，現在の状態の推定値
                    observation
                        センサーによる観測値
                カルマンフィルタによる値の更新
                    バッチではなくオンラインで処理する
            カルマンゲイン
                odometryとobservationの2つの値を合成して状態を推定するが、この2つの値のうち，どちらをどれだけ重要視するかをカルマンゲインというパラメータを使ってコントロールする行列。
    4 章 状態推定：散漫カルマンフィルタ
        状態の初期値の問題
            散漫カルマンフィルタは、状態の分散の初期値をものすごく大きくしておいて、状態の期待値の初期値の影響をすぐ消滅させるテクニック
    5 章 状態推定：平滑化
        平滑化の考え方
            平滑化とは、データにおける重要パターンを、ノイズなど、重要性の低いものを除去しながら見つけ出す方法。
            この平滑化のためにフィルター処理を使用する。
            平滑化の目的は、値の変化をなだらかにしてデータの傾向をわかりやすくすること。
    6 章 パラメタ推定：最尤法
第 6 部 状態空間モデルとベイズ推論
    1 章 一般化状態空間モデルとベイズ推論
        一般化状態空間モデル
            固定および調整可能なコンポーネントが混在している制御システムを表すことができる
        非ガウシアンな観測データ
        非線形な状態の更新式
        補足：HMC(ハミルトニアン・モンテカルロ）法とカルマンフィルタの比較
            HMC法
                バッチ処理、一回の計算負荷が高い、フィルタリングはなく，最初から平滑化を行われている、
                状態推定とパラメタ推定を同時に行う
            カルマンフィルタ
                逐次処理、一回の計算量は少なめ、フィルタリングをした後平滑化を行う、
                状態の推定とは別に最尤法で推定する必要がある
    2 章 パラメタと状態の推定：ベイズ推論と HMC 法
        ベイズの定理と事前確率・事後確率の関係
        ベイズ更新
        ベイズの定理
        事前分布と事後分布
        点推定値としてのEAP推定量
            事後分布の期待値。Expected a posterior。
        統計モデルと階層的な確率分布
        無情報事前分布
            一様分布、共役事前分布や Jeffreys 事前分布などが用いられる
        パラメタ推定と乱数生成アルゴリズムの関係
        乱数生成
            メトロポリス法
            効率の良い乱数生成：HMC 法



# 参考


## 全体
[時系列解析―自己回帰型モデル・状態空間モデル・異常検知― ](https://www.kyoritsu-pub.co.jp/bookdetail/9784320125018)  
[時系列データへの回帰分析フローチャート](https://logics-of-blue.com/time-series-regression/)  


## 自己回帰型モデル
[未来を予測するビッグデータの解析手法と「SARIMAモデル」](https://deepage.net/bigdata/2016/10/22/bigdata-analytics.html)  
[MA過程の反転可能性](https://analytics-note.xyz/time-series/ma-invertible/)  
[ARCHモデル](https://ja.wikipedia.org/wiki/ARCH%E3%83%A2%E3%83%87%E3%83%AB)  
[VARモデルによる計量時系列分析の基本と因果推定 with R](https://qiita.com/saltcooky/items/2d0119ea4a10bab6cff2)  


## 状態空間モデル
[時系列分析と状態空間モデルの基礎](https://logics-of-blue.com/wp-content/uploads/2018/01/tsa-ssm-book-contents.pdf)  
[状態空間モデルの考え方・使い方](https://www.slideshare.net/horihorio/tokyo-r38-33704463)  
[ランダムウォーク, ローカルレベルモデル](https://logics-of-blue.com/%E3%83%AD%E3%83%BC%E3%82%AB%E3%83%AB%E3%83%AC%E3%83%99%E3%83%AB%E3%83%A2%E3%83%87%E3%83%AB/#:~:text=%EF%BC%92%EF%BC%8E%E3%83%AD%E3%83%BC%E3%82%AB%E3%83%AB%E3%83%BB%E3%83%AC%E3%83%99%E3%83%AB%E3%83%BB%E3%83%A2%E3%83%87%E3%83%AB&text=%E3%81%93%E3%81%84%E3%81%A4%E3%81%8C%E4%BD%95%E3%81%AA%E3%81%AE%E3%81%8B,%E3%83%97%E3%83%A9%E3%82%B9%20%E3%83%8E%E3%82%A4%E3%82%BA%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AA%E3%82%93%E3%81%A7%E3%81%99%E3%81%AD%E3%80%82)  
[カルマンフィルタってなに？](https://qiita.com/IshitaTakeshi/items/740ac7e9b549eee4cc04)  
